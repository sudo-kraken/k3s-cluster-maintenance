---
# Cluster preparation tasks - Longhorn, cordoning, and draining
- name: Check for Longhorn on this node
  delegate_to: localhost
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    field_selectors:
      - spec.nodeName={{ inventory_hostname }}
    namespace: longhorn-system
  register: k3s_node_maintenance_longhorn_pods_info
  tags: [cluster, prepare, longhorn]

- name: Disable Longhorn scheduling (if present)
  delegate_to: localhost
  when: (k3s_node_maintenance_longhorn_pods_info.resources | length) > 0
  tags: [cluster, prepare, longhorn]
  block:
    - name: Check Longhorn Node CR
      kubernetes.core.k8s_info:
        api_version: longhorn.io/v1beta2
        kind: Node
        name: "{{ inventory_hostname }}"
        namespace: longhorn-system
      register: k3s_node_maintenance_longhorn_node_check

    - name: Disable scheduling
      kubernetes.core.k8s:
        api_version: longhorn.io/v1beta2
        kind: Node
        name: "{{ inventory_hostname }}"
        namespace: longhorn-system
        state: present
        merge_type: merge
        definition:
          spec:
            allowScheduling: false
      when: k3s_node_maintenance_longhorn_node_check.resources | length > 0

    - name: Wait for Longhorn to disable scheduling
      ansible.builtin.pause:
        seconds: 15
      when: k3s_node_maintenance_longhorn_node_check.resources | length > 0

- name: Prepare node for maintenance
  delegate_to: localhost
  tags: [cluster, prepare, drain]
  block:
    - name: Cordon node
      kubernetes.core.k8s:
        api_version: v1
        kind: Node
        name: "{{ inventory_hostname }}"
        state: present
        merge_type: strategic-merge
        definition:
          spec:
            unschedulable: true

    - name: Get pods to drain
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        field_selectors:
          - spec.nodeName={{ inventory_hostname }}
      register: k3s_node_maintenance_node_pods

    - name: Filter drainable pods
      ansible.builtin.set_fact:
        k3s_node_maintenance_pods_to_drain: |
          {%- set filtered_pods = [] -%}
          {%- for pod in k3s_node_maintenance_node_pods.resources -%}
            {%- set is_daemonset = false -%}
            {%- if pod.metadata.ownerReferences is defined -%}
              {%- for owner in pod.metadata.ownerReferences -%}
                {%- if owner.kind == "DaemonSet" -%}
                  {%- set is_daemonset = true -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- if not is_daemonset and pod.metadata.namespace != "kube-system" -%}
              {%- set _ = filtered_pods.append(pod) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ filtered_pods }}

    - name: Node drain status
      ansible.builtin.debug:
        msg: "ðŸ”„ Draining {{ k3s_node_maintenance_pods_to_drain | length }} pods from {{ inventory_hostname }}"
      when: k3s_node_maintenance_pods_to_drain | length > 0

    - name: Drain pods from node
      kubernetes.core.k8s:
        api_version: v1
        kind: Pod
        name: "{{ item.metadata.name }}"
        namespace: "{{ item.metadata.namespace }}"
        state: absent
        wait: true
        wait_timeout: 60
        delete_options:
          gracePeriodSeconds: 30
      loop: "{{ k3s_node_maintenance_pods_to_drain }}"
      loop_control:
        label: "{{ item.metadata.namespace }}/{{ item.metadata.name }}"
      register: k3s_node_maintenance_drain_result
      failed_when: false

    - name: Drain completed
      ansible.builtin.debug:
        msg: "âœ… Node drain completed - ready for maintenance"
